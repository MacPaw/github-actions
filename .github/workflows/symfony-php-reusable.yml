name: Symfony PHP Reusable Workflow

on:
  workflow_call:

    secrets:
      CODECOV_TOKEN:
        description: 'Token for Codecov uploads (optional)'
        required: false
      INFECTION_BADGE_API_KEY:
        description: 'API key for Infection badge (optional)'
        required: false

    inputs:
      matrix-include:
        description: |
          JSON array of additional matrix combinations to include.
          Use this to add specific package version combinations or custom configurations.
          Examples:
          - Add lowest dependencies test: [{"php":"8.2","dependencies":"lowest"}]
          - Add code coverage: [{"php":"8.3","symfony":"7.0.*","coverage":"xdebug"}]
          - Test specific package versions: [{"php":"8.2","symfony":"6.4.*","doctrine/orm":"2.14.*"}]
        required: false
        type: string
        default: '[]'
      versions-matrix:
        description: |
          JSON object with package versions to test.
          - PHP versions create matrix combinations with Symfony versions
          - Symfony versions are tested with each PHP version
          - Additional packages are installed from first version in array
          - Use matrix-include for specific package version combinations
          Format: {"php": ["8.2", "8.3"], "symfony/framework-bundle": ["6.4.*", "7.0.*"], "package/name": ["1.0.*"]}
        required: false
        type: string
        default: |
          {
            "php": ["8.2", "8.3", "8.4"],
            "symfony/framework-bundle": ["6.4.*", "7.0.*", "7.3.*"]
          }
      enable-phpstan:
        description: 'Enable PHPStan static analysis'
        required: false
        type: boolean
        default: true
      enable-phpcs:
        description: 'Enable PHP_CodeSniffer'
        required: false
        type: boolean
        default: true
      enable-php-cs-fixer:
        description: 'Enable PHP-CS-Fixer'
        required: false
        type: boolean
        default: false
      enable-rector:
        description: 'Enable Rector checks'
        required: false
        type: boolean
        default: false
      enable-infection:
        description: 'Enable Infection mutation testing'
        required: false
        type: boolean
        default: false
      enable-commitlint:
        description: 'Enable commit message linting'
        required: false
        type: boolean
        default: false
      enable-composer-validate:
        description: 'Enable Composer validation'
        required: false
        type: boolean
        default: true
      enable-coverage-check:
        description: 'Enable coverage validation and PR comments'
        required: false
        type: boolean
        default: false
      coverage-threshold:
        description: 'Minimum code coverage percentage required (0-100)'
        required: false
        type: number
        default: 70
      coverage-file:
        description: 'Coverage file name (Clover XML format)'
        required: false
        type: string
        default: 'coverage.xml'
      phpstan-level:
        description: 'PHPStan level (0-9 or max)'
        required: false
        type: string
        default: 'max'
      working-directory:
        description: 'Working directory for the project'
        required: false
        type: string
        default: '.'
      php-extensions:
        description: 'Additional PHP extensions to install'
        required: false
        type: string
        default: 'mbstring, json'
      php-version-quality-tools:
        description: 'PHP version to use for quality tools (PHPStan, PHPCS, Rector, Infection, etc.)'
        required: false
        type: string
        default: '8.3'
      matrix-exclude:
        description: 'JSON array of matrix combinations to exclude (e.g. [{"php": "8.1", "symfony/framework-bundle": "7.0.*"}]). Default excludes Symfony 7.x with PHP < 8.2'
        required: false
        type: string
        default: |
          [
            {"php": "7.4", "symfony/framework-bundle": "7.0.*"},
            {"php": "8.0", "symfony/framework-bundle": "7.0.*"},
            {"php": "8.1", "symfony/framework-bundle": "7.0.*"},
            {"php": "7.4", "symfony/framework-bundle": "7.1.*"},
            {"php": "8.0", "symfony/framework-bundle": "7.1.*"},
            {"php": "8.1", "symfony/framework-bundle": "7.1.*"},
            {"php": "7.4", "symfony/framework-bundle": "7.2.*"},
            {"php": "8.0", "symfony/framework-bundle": "7.2.*"},
            {"php": "8.1", "symfony/framework-bundle": "7.2.*"},
            {"php": "7.4", "symfony/framework-bundle": "7.3.*"},
            {"php": "8.0", "symfony/framework-bundle": "7.3.*"},
            {"php": "8.1", "symfony/framework-bundle": "7.3.*"}
          ]
      infection-min-msi:
        description: 'Minimum Mutation Score Indicator (MSI) for Infection'
        required: false
        type: number
        default: 80
      infection-min-covered-msi:
        description: 'Minimum Covered Code MSI for Infection'
        required: false
        type: number
        default: 90
      phpstan-config:
        description: 'Path to PHPStan configuration file (default: phpstan.neon.dist or phpstan.neon)'
        required: false
        type: string
        default: ''
      phpcs-config:
        description: 'Path to PHP_CodeSniffer configuration file (default: phpcs.xml.dist or phpcs.xml)'
        required: false
        type: string
        default: ''
      php-cs-fixer-config:
        description: 'Path to PHP-CS-Fixer configuration file (default: .php-cs-fixer.dist.php or .php-cs-fixer.php)'
        required: false
        type: string
        default: ''
      rector-config:
        description: 'Path to Rector configuration file (default: rector.php)'
        required: false
        type: string
        default: ''
      infection-config:
        description: 'Path to Infection configuration file (default: infection.json5 or infection.json)'
        required: false
        type: string
        default: ''
      commitlint-config:
        description: 'Path to Commitlint configuration file (default: .commitlintrc.json)'
        required: false
        type: string
        default: ''

env:
  COMPOSER_ROOT_VERSION: "1.0.0"

jobs:


  commitlint:
    name: Commit Lint
    runs-on: ubuntu-latest
    if: inputs['enable-commitlint']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install commitlint
        run: |
          npm install --save-dev @commitlint/{config-conventional,cli}

      - name: Validate current commit (single commit)
        if: github.event_name == 'push'
        run: |
          if [ -n "${{ inputs.commitlint-config }}" ]; then
            npx commitlint --from HEAD~1 --to HEAD --verbose --config ${{ inputs.commitlint-config }}
          else
            npx commitlint --from HEAD~1 --to HEAD --verbose
          fi

      - name: Validate PR commits
        if: github.event_name == 'pull_request'
        run: |
          if [ -n "${{ inputs.commitlint-config }}" ]; then
            npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose --config ${{ inputs.commitlint-config }}
          else
            npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose
          fi


  composer-validate:
    name: Composer Validate
    runs-on: ubuntu-latest
    if: inputs['enable-composer-validate']
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs['php-version-quality-tools'] }}
          coverage: none

      - name: Validate composer.json and composer.lock
        working-directory: ${{ inputs['working-directory'] }}
        run: composer validate --strict --no-check-publish


  phpcs:
    name: PHP_CodeSniffer
    runs-on: ubuntu-latest
    if: inputs['enable-phpcs']
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs['php-version-quality-tools'] }}
          coverage: none
          extensions: ${{ inputs['php-extensions'] }} xdebug

      - name: Get Composer cache directory
        id: composer-cache
        working-directory: ${{ inputs['working-directory'] }}
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        working-directory: ${{ inputs.working-directory }}
        run: composer install --no-interaction --no-progress --prefer-dist

      - name: Run PHP_CodeSniffer
        working-directory: ${{ inputs.working-directory }}
        run: |
          if [ -n "${{ inputs.phpcs-config }}" ]; then
            vendor/bin/phpcs --standard=${{ inputs.phpcs-config }}
          else
            vendor/bin/phpcs
          fi


  php-cs-fixer:
    name: PHP-CS-Fixer
    runs-on: ubuntu-latest
    if: inputs['enable-php-cs-fixer']
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs['php-version-quality-tools'] }}
          coverage: none
          extensions: ${{ inputs['php-extensions'] }}

      - name: Get Composer cache directory
        id: composer-cache
        working-directory: ${{ inputs['working-directory'] }}
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        working-directory: ${{ inputs.working-directory }}
        run: composer install --no-interaction --no-progress --prefer-dist

      - name: Run PHP-CS-Fixer
        working-directory: ${{ inputs['working-directory'] }}
        run: |
          if [ -n "${{ inputs['php-cs-fixer-config'] }}" ]; then
            vendor/bin/php-cs-fixer fix --dry-run --diff --verbose --config=${{ inputs['php-cs-fixer-config'] }}
          else
            vendor/bin/php-cs-fixer fix --dry-run --diff --verbose
          fi


  phpstan:
    name: PHPStan
    runs-on: ubuntu-latest
    if: inputs['enable-phpstan']
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs['php-version-quality-tools'] }}
          coverage: none
          extensions: ${{ inputs['php-extensions'] }}

      - name: Get Composer cache directory
        id: composer-cache
        working-directory: ${{ inputs['working-directory'] }}
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        working-directory: ${{ inputs.working-directory }}
        run: composer install --no-interaction --no-progress --prefer-dist

      - name: Run PHPStan
        working-directory: ${{ inputs['working-directory'] }}
        run: |
          if [ -n "${{ inputs['phpstan-config'] }}" ]; then
            vendor/bin/phpstan analyse --level=${{ inputs['phpstan-level'] }} --no-progress -c ${{ inputs['phpstan-config'] }}
          else
            vendor/bin/phpstan analyse --level=${{ inputs['phpstan-level'] }} --no-progress
          fi


  rector:
    name: Rector
    runs-on: ubuntu-latest
    if: inputs['enable-rector']
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs['php-version-quality-tools'] }}
          coverage: none
          extensions: ${{ inputs['php-extensions'] }}

      - name: Get Composer cache directory
        id: composer-cache
        working-directory: ${{ inputs['working-directory'] }}
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        working-directory: ${{ inputs.working-directory }}
        run: composer install --no-interaction --no-progress --prefer-dist

      - name: Run Rector
        working-directory: ${{ inputs['working-directory'] }}
        run: |
          if [ -n "${{ inputs['rector-config'] }}" ]; then
            vendor/bin/rector process --dry-run --config ${{ inputs['rector-config'] }}
          else
            vendor/bin/rector process --dry-run
          fi


  generate-matrix:
    name: Generate Test Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
    steps:
      - name: Generate matrix combinations
        id: generate
        run: |
          cat > generate_matrix.py << 'PYTHON_SCRIPT'
          import json
          import sys
          from itertools import product

          # Read inputs
          versions_matrix = json.loads('''${{ inputs['versions-matrix'] }}''')
          matrix_include = json.loads('''${{ inputs['matrix-include'] }}''')
          matrix_exclude = json.loads('''${{ inputs['matrix-exclude'] }}''')

          # Separate PHP from other packages
          php_versions = versions_matrix.get('php', [])
          packages = {k: v for k, v in versions_matrix.items() if k != 'php'}

          # Generate Cartesian product of all package versions
          if not packages:
              # If no packages, just use PHP versions
              combinations = [
                  {
                      'php': php,
                      'dependencies': 'highest',
                      'title': f"PHP {php}"
                  }
                  for php in php_versions
              ]
          else:
              package_names = list(packages.keys())
              package_versions = [packages[name] for name in package_names]

              combinations = []
              for php in php_versions:
                  for combo in product(*package_versions):
                      combination = {
                          'php': php,
                          'dependencies': 'highest'
                      }
                      # Add each package version to the combination
                      for i, package_name in enumerate(package_names):
                          combination[package_name] = combo[i]

                      # Generate title for this combination
                      title_parts = [f"PHP {php}"]
                      for i, package_name in enumerate(package_names):
                          # Shorten package name for display (e.g., "symfony/cache" -> "cache")
                          short_name = package_name.split('/')[-1] if '/' in package_name else package_name
                          title_parts.append(f"{short_name} {combo[i]}")
                      combination['title'] = ', '.join(title_parts)

                      combinations.append(combination)

          # Add matrix-include items and generate titles if missing
          for include_item in matrix_include:
              if 'title' not in include_item:
                  # Generate title for matrix-include items
                  title_parts = [f"PHP {include_item.get('php', '?')}"]
                  for key, value in include_item.items():
                      if key not in ['php', 'dependencies', 'coverage', 'title']:
                          short_name = key.split('/')[-1] if '/' in key else key
                          title_parts.append(f"{short_name} {value}")
                  if include_item.get('dependencies') == 'lowest':
                      title_parts.append('lowest deps')
                  if include_item.get('coverage'):
                      title_parts.append(f"coverage: {include_item['coverage']}")
                  include_item['title'] = ', '.join(title_parts)
              combinations.append(include_item)

          # Filter out excluded combinations
          def should_exclude(combo, exclude_rules):
              for rule in exclude_rules:
                  if all(combo.get(k) == v for k, v in rule.items()):
                      return True
              return False

          final_combinations = [c for c in combinations if not should_exclude(c, matrix_exclude)]

          # Output as JSON
          matrix_json = json.dumps({'include': final_combinations})
          print(f"Generated {len(final_combinations)} test combinations")

          # Write to GITHUB_OUTPUT
          import os
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"matrix={matrix_json}\n")
          PYTHON_SCRIPT

          python3 generate_matrix.py

      - name: Display matrix
        run: |
          echo "Generated matrix:"
          echo '${{ steps.generate.outputs.matrix }}' | jq .


  unit-tests:
    name: Unit Tests (${{ matrix.title }})
    runs-on: ubuntu-latest
    needs: generate-matrix
    timeout-minutes: 15
    env:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.generate-matrix.outputs.matrix) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          coverage: ${{ matrix.coverage || 'none' }}
          extensions: ${{ inputs['php-extensions'] }}${{ matrix.coverage == 'xdebug' && ', xdebug' || '' }}

      - name: Get Composer cache directory
        id: composer-cache
        working-directory: ${{ inputs['working-directory'] }}
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-php-${{ matrix.php }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-php-${{ matrix.php }}-composer-

      - name: Display matrix combination
        run: |
          echo "Testing with following package versions:"
          echo '${{ toJSON(matrix) }}' | jq .

      - name: Apply package version constraints from matrix
        id: apply-constraints
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "Applying package version constraints from matrix combination..."

          # Get all matrix keys except system keys
          MATRIX_JSON='${{ toJSON(matrix) }}'

          # Extract and apply each package version from matrix
          # Skip system keys: php, dependencies, coverage, title, description
          PACKAGES_STR=""
          PACKAGES_JSON="{}"
          SYMFONY_VERSION=""

          for package in $(echo "$MATRIX_JSON" | jq -r 'keys[]' | grep -v -E '^(php|dependencies|coverage|title|description)$'); do
            VERSION=$(echo "$MATRIX_JSON" | jq -r --arg pkg "$package" '.[$pkg]')

            if [ ! -z "$VERSION" ] && [ "$VERSION" != "null" ] && [ "$VERSION" != "" ]; then
              echo "Setting $package to $VERSION"
              composer require "$package:$VERSION" --no-update --no-interaction || echo "Warning: Could not set constraint for $package"

              # Set Symfony version globally if this is symfony/framework-bundle
              if [ "$package" = "symfony/framework-bundle" ]; then
                echo "Setting Symfony global version constraint"
                composer config extra.symfony.require "$VERSION" || true
                SYMFONY_VERSION="$VERSION"
              fi

              # Build outputs
              if [ -z "$PACKAGES_STR" ]; then
                PACKAGES_STR="$package:$VERSION"
              else
                PACKAGES_STR="$PACKAGES_STR $package:$VERSION"
              fi
              PACKAGES_JSON=$(echo "$PACKAGES_JSON" | jq --arg k "$package" --arg v "$VERSION" '. + {($k): $v}')
            fi
          done

          # If Symfony version wasn't set via framework-bundle, try to infer from any symfony/* package in the matrix
          if [ -z "$SYMFONY_VERSION" ]; then
            SYMFONY_VERSION=$(echo "$MATRIX_JSON" | jq -r 'to_entries | map(select(.key|test("^symfony/"))) | (.[0].value // "")')
            if [ -n "$SYMFONY_VERSION" ]; then
              echo "Inferred Symfony version $SYMFONY_VERSION from symfony/* package; setting extra.symfony.require"
              composer config extra.symfony.require "$SYMFONY_VERSION" || true
            fi
          fi

          echo "‚úì Package version constraints applied successfully"

          # Export step outputs
          echo "composer_packages=$PACKAGES_STR" >> "$GITHUB_OUTPUT"
          echo "composer_packages_json=$(echo "$PACKAGES_JSON" | jq -c '.')" >> "$GITHUB_OUTPUT"
          echo "symfony_version=$SYMFONY_VERSION" >> "$GITHUB_OUTPUT"

      - name: Install dependencies
        working-directory: ${{ inputs['working-directory'] }}
        run: |
          echo "Requested constraints: ${{ steps.apply-constraints.outputs.composer_packages }}"
          if [ "${{ matrix.dependencies }}" = "lowest" ]; then
            echo "Installing lowest compatible dependencies..."
            composer update --prefer-lowest --prefer-stable --no-interaction --no-progress
          else
            echo "Installing highest (locked) dependencies..."
            composer update --no-interaction --no-progress --prefer-dist
          fi

      - name: Run PHPUnit
        if: matrix.coverage != 'xdebug'
        working-directory: ${{ inputs['working-directory'] }}
        run: vendor/bin/phpunit --testdox --no-coverage

      - name: Run PHPUnit with coverage
        if: matrix.coverage == 'xdebug'
        working-directory: ${{ inputs['working-directory'] }}
        run: |
          # Generate both Clover XML (for Codecov and fallback) and raw PHP coverage (for phpcov merge)
          vendor/bin/phpunit \
            --testdox \
            --coverage-clover=${{ inputs['coverage-file'] }} \
            --coverage-php=coverage.cov

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: matrix.coverage == 'xdebug' && env.CODECOV_TOKEN != ''
        with:
          token: ${{ env.CODECOV_TOKEN }}
          files: ${{ inputs['working-directory'] }}/${{ inputs['coverage-file'] }}
          fail_ci_if_error: false

      - name: Upload coverage artifact for validation
        if: matrix.coverage == 'xdebug'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.php }}-${{ github.run_id }}
          path: |
            ${{ inputs['working-directory'] }}/${{ inputs['coverage-file'] }}
            ${{ inputs['working-directory'] }}/coverage.cov
          retention-days: 1
          if-no-files-found: warn


  coverage-validation:
    name: Coverage Validation
    runs-on: ubuntu-latest
    needs: unit-tests
    if: inputs['enable-coverage-check'] && github.event_name == 'pull_request'
    env:
      COVERAGE_FILE: ${{ inputs['coverage-file'] }}
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Setup PHP for phpcov
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs['php-version-quality-tools'] }}
          coverage: none

      - name: Install phpcov
        run: |
          composer global require --no-interaction --no-progress \
            phpcov/phpcov:^8 \
            rregeer/phpunit-coverage-check:^1.0
          # Add Composer global bin to PATH for both Composer 1 and 2 locations
          echo "$HOME/.composer/vendor/bin" >> $GITHUB_PATH
          echo "$HOME/.config/composer/vendor/bin" >> $GITHUB_PATH

      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-report-*
          path: coverage-artifacts
          merge-multiple: false
        continue-on-error: true

      - name: Merge coverage reports with phpcov
        id: phpcov-merge
        run: |
          set -e
          if [ ! -d "coverage-artifacts" ] || [ -z "$(ls -A coverage-artifacts || true)" ]; then
            echo "No coverage artifacts to merge"
            echo "merged=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Build list of directories that contain raw PHP coverage files produced by PHPUnit (--coverage-php)
          mapfile -t COVERAGE_DIRS < <(find coverage-artifacts -type f -name "coverage.cov" -exec dirname {} \; | sort -u)

          if [ ${#COVERAGE_DIRS[@]} -eq 0 ]; then
            echo "No raw PHP coverage files (coverage.cov) found for merging"
            echo "merged=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found ${#COVERAGE_DIRS[@]} coverage directories to merge"
          printf '%s\n' "${COVERAGE_DIRS[@]}" | sed 's/^/- /'

          # Try merging with phpcov; if it fails, we will fallback later
          set +e
          phpcov merge --clover merged-coverage.xml "${COVERAGE_DIRS[@]}"
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -ne 0 ] || [ ! -s merged-coverage.xml ]; then
            echo "phpcov merge failed or produced empty output; will continue without merged file"
            echo "merged=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "phpcov merge succeeded"
          echo "merged=true" >> $GITHUB_OUTPUT

      - name: Parse coverage and validate threshold (phpunit-coverage-check)
        id: coverage
        env:
          COVERAGE_THRESHOLD: ${{ inputs['coverage-threshold'] }}
        run: |
          set -e
          # Ensure artifacts exist
          if [ ! -d "coverage-artifacts" ] || [ -z "$(ls -A coverage-artifacts || true)" ]; then
            echo "‚ö†Ô∏è No coverage artifacts found"
            echo "coverage=0.0" >> $GITHUB_OUTPUT
            echo "status=no-coverage" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Determine target files for checking
          if [ -s "merged-coverage.xml" ]; then
            TARGETS=("merged-coverage.xml")
          else
            mapfile -t TARGETS < <(find coverage-artifacts -type f -name "${{ inputs['coverage-file'] }}")
          fi

          if [ ${#TARGETS[@]} -eq 0 ]; then
            echo "‚ö†Ô∏è No Clover XML files found"
            echo "coverage=0.0" >> $GITHUB_OUTPUT
            echo "status=no-coverage" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Run phpunit-coverage-check. If multiple files, record minimum coverage and mark failure if any fail.
          OVERALL_STATUS=success
          MIN_COVERAGE=""
          for FILE in "${TARGETS[@]}"; do
            set +e
            phpunit-coverage-check --min="${COVERAGE_THRESHOLD}" "$FILE" | tee coverage_check_output.txt
            EXIT_CODE=$?
            set -e
            # Extract percentage like 85.23 from the tool output (last occurrence)
            PCT=$(sed -nE 's/.*([0-9]+\.[0-9]+)%.*$/\1/p' coverage_check_output.txt | tail -n1)
            if [ -z "$PCT" ]; then
              # Fallback: try to read line-rate from Clover and convert to percent
              LR=$(grep -o 'line-rate="[0-9.]*"' "$FILE" | head -1 | sed -E 's/.*="([0-9.]+)"/\1/')
              PCT=$(awk -v lr="${LR:-0}" 'BEGIN { printf "%.2f", (lr+0)*100 }')
            fi

            if [ -z "$MIN_COVERAGE" ]; then
              MIN_COVERAGE="$PCT"
            else
              awk -v a="$MIN_COVERAGE" -v b="$PCT" 'BEGIN { exit !(a+0 > b+0) }' || MIN_COVERAGE="$PCT"
            fi

            if [ $EXIT_CODE -ne 0 ]; then
              OVERALL_STATUS=failure
            fi
          done

          echo "coverage=${MIN_COVERAGE:-0.00}" >> $GITHUB_OUTPUT
          echo "status=$OVERALL_STATUS" >> $GITHUB_OUTPUT

      - name: Create or update PR comment
        uses: peter-evans/create-or-update-comment@v5
        if: always() && steps.coverage.outputs.status != 'no-coverage'
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            <!-- coverage-validation-report -->
            ## üìä Code Coverage Report
            ${{ steps.coverage.outputs.status == 'success'
                && format('‚úÖCoverage: {0}% (min {1}%) ‚Äî OK', steps.coverage.outputs.coverage, inputs['coverage-threshold'])
                || format('‚ùåCoverage: {0}% (min {1}%) ‚Äî NOT OK', steps.coverage.outputs.coverage, inputs['coverage-threshold'])
            }}

            ---
            <sub>Generated by [Symfony PHP Reusable Workflow](https://github.com/MacPaw/github-actions)</sub>
          body-includes: '<!-- coverage-validation-report -->'
          edit-mode: replace

      - name: Fail if coverage below threshold
        if: steps.coverage.outputs.status == 'failure'
        run: |
          echo "‚ùå Coverage ${{ steps.coverage.outputs.coverage }}% is below threshold ${{ inputs['coverage-threshold'] }}%"
          exit 1


  infection:
    name: Infection Mutation Testing
    runs-on: ubuntu-latest
    if: inputs['enable-infection']
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs['php-version-quality-tools'] }}
          coverage: xdebug
          extensions: ${{ inputs['php-extensions'] }}

      - name: Get Composer cache directory
        id: composer-cache
        working-directory: ${{ inputs['working-directory'] }}
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        working-directory: ${{ inputs['working-directory'] }}
        run: composer install --no-interaction --no-progress --prefer-dist

      - name: Run Infection
        working-directory: ${{ inputs['working-directory'] }}
        run: |
          CMD="vendor/bin/infection --min-msi=${{ inputs['infection-min-msi'] }} --min-covered-msi=${{ inputs['infection-min-covered-msi'] }} --threads=4 --no-progress"
          if [ -n "${{ inputs['infection-config'] }}" ]; then
            CMD="$CMD --configuration=${{ inputs['infection-config'] }}"
          fi
          $CMD
        env:
          INFECTION_BADGE_API_KEY: ${{ secrets.INFECTION_BADGE_API_KEY }}
